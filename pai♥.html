<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="6viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlama Animasyonu</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: transparent;
            font-family: 'Roboto', sans-serif;
            /* OBS optimizasyonu */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeSpeed;
            /* GPU hÄ±zlandÄ±rma */
            transform: translateZ(0);
            backface-visibility: hidden;
            /* OBS iÃ§in optimize edilmiÅŸ rendering */
            image-rendering: optimizeSpeed;
            image-rendering: -webkit-optimize-contrast;
            /* SVG optimizasyonu */
            image-rendering: crisp-edges;
            image-rendering: pixelated;
        }

        body {
            position: relative;
            min-width: 100vw;
            min-height: 100vh;
        }

        /* * NOT: ID (#karakter) -> SINIF (.karakter) olarak dÃ¼zeltildi.
         * JS kodumuz '.karakter' sÄ±nÄ±fÄ±na sahip elementler oluÅŸturduÄŸu iÃ§in bu gereklidir.
         * JS, boyut ve resim gibi stilleri dinamik olarak ezer,
         * ancak 'transition' gibi stiller buradan alÄ±nÄ±r.
        */
        .karakter {
            width: 100px;
            height: 120px;
            background-image: url('karakter.png');
            background-size: 100px 120px;
            background-repeat: no-repeat;
            background-position: center;
            position: absolute;
            top: -150px;
            left: -150px;
            opacity: 0;
            z-index: 10; /* Bu, JS tarafÄ±ndan (20 olarak) ezilecektir */
            transition: opacity 0.3s ease; /* Bu stil Ã¶nemlidir */
            /* Performans optimizasyonu */
            will-change: transform;
            transform: translateZ(0);
        }

        #havuz {
            width: 298px;
            height: 83px;
            background-image: url('havuz.svg'), url('havuz.png');
            background-size: 298px 83px;
            background-repeat: no-repeat;
            background-position: center;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateZ(0);
            box-sizing: border-box;
            transition: opacity 0.5s ease;
            z-index: 5;
            will-change: transform, opacity;
            backface-visibility: hidden;
            image-rendering: optimizeSpeed;
            image-rendering: crisp-edges;
        }
    </style>
    </head>

<body>
    <div id="havuz"></div>

    <audio id="atlama-sesi" preload="auto" style="display: none;">
        <source src="vada.mp3" type="audio/mpeg">
    </audio>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const havuz = document.getElementById('havuz');
        const atlamaSesi = document.getElementById('atlama-sesi');

        // =================================================================
        // === AYAR KUTUSU (CONFIG) ===
        // =================================================================
        const AYARLAR = {
            // --- KICK AYARLARI ---

            // !!! Ã–NEMLÄ°: Buraya baÄŸlanÄ±lacak sohbet odasÄ±nÄ±n ID'sini manuel girin !!!
            kickChatroomID: 24986517, 

            // Kick sohbet URL'si (DeÄŸiÅŸirse buradan gÃ¼ncelleyin)
            kickWebSocketUrl: "wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=7.6.0&flash=false", 

            // --- YETKÄ°LÄ° AYARLARI ---
            yetkiliListesi: ["pairaaa", "youarerightpaira", "himilayk"],
            topluAtlamaGecikmesi: 100, // YarÄ±m saniye

            // --- KARAKTER GRUPLARI ---
            ozelKarakterGruplari: {
                'grup1': {
                    resim: '1.png',
                    kullanicilar: ['kullanici1', 'kullanici2', 'testuser']
                },
                'grup2': {
                    resim: '2.png',
                    kullanicilar: ['baska_biri', 'deneme']
                },
                'grup3': {
                    resim: '3.png',
                    kullanicilar: []
                }
            },

            // --- DÄ°ÄER AYARLAR ---
            testModu: false,
            fizik: {
                yerCekimi: 0.05,
                temelHiz: 3,
                hizVaryasyon: 1.5,
                minimumAci: 15,
                maksimumAci: 60,
                minimumIvme: 0.66,
                maksimumIvme: 1
            },
            puanlama: {
                basariMesafeSiniri: 135,
                puanlamaKatsayisi: 1.35
            }
        };
        // =================================================================
        // === AYAR KUTUSU SONU ===
        // =================================================================

        // --- Ekran ve Ã–lÃ§eklendirme AyarlarÄ± ---
        let ekranGenisligi = Math.max(window.innerWidth, document.documentElement.clientWidth) || 1920; 
        let ekranYuksekligi = Math.max(window.innerHeight, document.documentElement.clientHeight) || 1080;
        console.log(`ğŸ“ Ekran boyutlarÄ± algÄ±landÄ±: ${ekranGenisligi}x${ekranYuksekligi}`);
        const temelEkranGenisligi = 1920;
        const temelEkranYuksekligi = 1080;
        const genislikOran = ekranGenisligi / temelEkranGenisligi;
        const yukseklikOran = ekranYuksekligi / temelEkranYuksekligi;
        const ortalamaOran = (genislikOran + yukseklikOran) / 2;
        console.log(`ğŸ“ Ekran Ã¶lÃ§eklendirme: Oran: ${ortalamaOran.toFixed(2)}`);
        document.body.style.imageRendering = 'optimizeSpeed';
        document.body.style.imageRendering = '-webkit-optimize-contrast';
        console.log('ğŸ¥ OBS optimizasyonu aktif');

        // --- Global DeÄŸiÅŸkenler ---
        let havuzGizli = false;
        let havuzGizlemeTimer = null;
        let atlayanKullanicilar = new Set();
        let karakterPozisyonlari = new Map();
        let enYuksekSkor = 0;
        let enYuksekSkorKullanici = '';
        let topluAtlamaAktif = false;
        let atlamaSirasi = [];

        // --- En YÃ¼ksek Skor GÃ¶stergesi ---
        const skorGosterici = document.createElement('div');
        skorGosterici.id = 'skor-gosterici';
        skorGosterici.style.position = 'fixed';
        skorGosterici.style.bottom = '10px';
        skorGosterici.style.left = '10px';
        skorGosterici.style.color = '#C8A2C8';
        skorGosterici.style.fontSize = '16px';
        skorGosterici.style.fontWeight = '500';
        skorGosterici.style.fontFamily = "'Roboto', sans-serif";
        skorGosterici.style.textShadow = '2px 2px 4px black';
        skorGosterici.style.zIndex = '100';
        skorGosterici.style.pointerEvents = 'none';
        skorGosterici.textContent = 'En YÃ¼ksek Skor: HenÃ¼z yok';
        document.body.appendChild(skorGosterici);

        // --- Havuz FonksiyonlarÄ± ---
        function rastgeleHavuzKonumu() {
            const guncelGenislik = Math.max(window.innerWidth, document.documentElement.clientWidth) || 1920;
            const havuzGenisligi = Math.round(298 * ortalamaOran);
            const havuzYuksekligi = Math.round(83 * ortalamaOran);
            const guvenliMargin = Math.round(50 * ortalamaOran);
            const solSinir = guvenliMargin;
            const sagSinir = guncelGenislik - havuzGenisligi - guvenliMargin;
            const gercekSolSinir = Math.min(solSinir, sagSinir);
            const gercekSagSinir = Math.max(solSinir, sagSinir);
            const rastgeleX = Math.random() * (gercekSagSinir - gercekSolSinir) + gercekSolSinir;
            havuz.style.left = rastgeleX + 'px';
            havuz.style.transform = 'none';
            havuz.style.opacity = '1';
            havuz.style.width = havuzGenisligi + 'px';
            havuz.style.height = havuzYuksekligi + 'px';
            havuz.style.backgroundSize = havuzGenisligi + 'px ' + havuzYuksekligi + 'px';
            havuzGizli = false;
            atlayanKullanicilar.clear();
            if (havuzGizlemeTimer) {
                clearTimeout(havuzGizlemeTimer);
                havuzGizlemeTimer = null;
            }
            console.log(`Havuz konumu: x=${rastgeleX}`);
        }

        rastgeleHavuzKonumu();

        // --- atlaAnimasyonunuBaslat Fonksiyonu ---
        function atlaAnimasyonunuBaslat(kullaniciAdi = 'Bilinmeyen', emojiId = null) {
            const aktifKarakterSayisi = document.querySelectorAll('.karakter').length;
            if (aktifKarakterSayisi > 6) {
                console.log(`âš ï¸ OBS optimizasyonu: Ã‡ok fazla aktif karakter (${aktifKarakterSayisi}), yeni atlama reddediliyor`);
                return;
            }

            if (!havuzGizli && atlayanKullanicilar.has(kullaniciAdi) && !topluAtlamaAktif) {
                console.log(`Bloklandi: ${kullaniciAdi} zaten atladi.`);
                return;
            }

            if (havuzGizli) {
                rastgeleHavuzKonumu();
            }
            atlayanKullanicilar.add(kullaniciAdi);

            if (atlamaSesi) {
                atlamaSesi.volume = 0.48;
                atlamaSesi.playbackRate = 1.6;
                atlamaSesi.currentTime = 0;
                atlamaSesi.play().catch(error => { console.warn("Ses oynatÄ±lamadÄ±:", error); });
            }

            if (havuzGizlemeTimer) {
                clearTimeout(havuzGizlemeTimer);
            }
            havuzGizlemeTimer = setTimeout(() => {
                havuz.style.opacity = '0';
                havuzGizli = true;
                console.log('Havuz gizlendi - uzun sÃ¼re atlama olmadÄ±');
            }, 30000);

            const karakter = document.createElement('div');
            karakter.className = 'karakter'; // CSS'teki .karakter sÄ±nÄ±fÄ±nÄ± kullanÄ±r
            console.log(`ğŸ¨ Karakter elementi oluÅŸturuldu: ${kullaniciAdi}`);

            // --- KARAKTER SEÃ‡Ä°MÄ° (GRUP KONTROLÃœ) ---
            let karakterGenisligi;
            let karakterYuksekligi;
            const emojiUrl = emojiId ? `https://files.kick.com/emotes/${emojiId}/fullsize` : null;
            let karakterBulundu = false;
            const normalizedUsername = kullaniciAdi.toLowerCase();

            // --- YENÄ°: Åike Tespiti ---
            const isSwitowski = normalizedUsername === 'switowski';
            let cheatBounceTarget = 0; // Hedef sekme sayÄ±sÄ±
            if (isSwitowski) {
                cheatBounceTarget = Math.floor(Math.random() * 4) + 1; // 1 ile 4 arasÄ±
                console.log(`âœ¨ BÄ°LARDO SÄ°STEMÄ° AKTÄ°F: ${kullaniciAdi} iÃ§in hedef ${cheatBounceTarget} sekme!`);
            }
            // --- BÄ°TTÄ° ---

            // --- GÃœNCELLENDÄ°: Åike kontrolÃ¼ eklendi ---
            if (isSwitowski) {
                karakter.style.backgroundImage = "url('karakter.svg'), url('karakter.png')"; // Veya Ã¶zel bir 'switowski.png'
                karakterGenisligi = Math.round(90 * ortalamaOran);
                karakterYuksekligi = Math.round(108 * ortalamaOran);
                karakterBulundu = true;
            } else if (normalizedUsername === 'pairaaa') {
                karakter.style.backgroundImage = "url('pairaaa.svg'), url('pairaaa.png')";
                karakterGenisligi = Math.round(90 * ortalamaOran);
                karakterYuksekligi = Math.round(108 * ortalamaOran);
                console.log(`ğŸŒŸ ${kullaniciAdi} - Ã–zel karakter kullanÄ±lÄ±yor!`);
                karakterBulundu = true;
            } else if (normalizedUsername === 'himilayk') {
                karakter.style.backgroundImage = "url('himilayk.svg'), url('himilayk.png')";
                karakterGenisligi = Math.round(90 * ortalamaOran);
                karakterYuksekligi = Math.round(108 * ortalamaOran);
                console.log(`ğŸŒŸ ${kullaniciAdi} - Ã–zel karakter kullanÄ±lÄ±yor!`);
                karakterBulundu = true;
            }
            // --- GÃœNCELLEME SONU ---

            if (!karakterBulundu) {
                for (const grup of Object.values(AYARLAR.ozelKarakterGruplari)) {
                    const kucukHarfKullanicilar = grup.kullanicilar.map(u => u.toLowerCase());
                    if (kucukHarfKullanicilar.includes(normalizedUsername)) {
                        karakter.style.backgroundImage = `url('${grup.resim}')`;
                        karakterGenisligi = Math.round(90 * ortalamaOran);
                        karakterYuksekligi = Math.round(108 * ortalamaOran);
                        console.log(`ğŸ‘¥ ${kullaniciAdi} - '${grup.resim}' grup karakteri kullanÄ±lÄ±yor!`);
                        karakterBulundu = true;
                        break;
                    }
                }
            }

            if (!karakterBulundu && emojiUrl) {
                karakter.style.backgroundImage = `url('${emojiUrl}')`;
                karakterGenisligi = Math.round(80 * ortalamaOran);
                karakterYuksekligi = Math.round(80 * ortalamaOran);
                console.log(`ğŸ¨ ${kullaniciAdi} - Emoji karakteri kullanÄ±lÄ±yor: ${emojiId}`);
                karakterBulundu = true;
            }

            if (!karakterBulundu) {
                karakter.style.backgroundImage = "url('karakter.svg'), url('karakter.png')";
                karakterGenisligi = Math.round(90 * ortalamaOran);
                karakterYuksekligi = Math.round(108 * ortalamaOran);
            }
            // --- KARAKTER SEÃ‡Ä°MÄ° SONU ---


            karakter.style.width = karakterGenisligi + 'px';
            karakter.style.height = karakterYuksekligi + 'px';
            karakter.style.backgroundSize = karakterGenisligi + 'px ' + karakterYuksekligi + 'px';

            karakter.style.backgroundRepeat = 'no-repeat';
            karakter.style.backgroundPosition = 'center';
            karakter.style.position = 'absolute';
            karakter.style.zIndex = '20'; 
            karakter.style.opacity = '1';
            karakter.style.willChange = 'transform, left, top';
            karakter.style.transform = 'translateZ(0)';
            karakter.style.backfaceVisibility = 'hidden';

            const kullaniciEtiketi = document.createElement('div');
            kullaniciEtiketi.className = 'kullanici-etiketi';
            kullaniciEtiketi.textContent = kullaniciAdi;
            kullaniciEtiketi.style.position = 'absolute';
            kullaniciEtiketi.style.left = '0px';
            kullaniciEtiketi.style.top = '0px';
            kullaniciEtiketi.style.color = '#C8A2C8';
            kullaniciEtiketi.style.fontSize = '16px';
            kullaniciEtiketi.style.fontWeight = '400';
            kullaniciEtiketi.style.fontFamily = "'Roboto', sans-serif";
            kullaniciEtiketi.style.zIndex = '11'; 
            kullaniciEtiketi.style.pointerEvents = 'none';
            kullaniciEtiketi.style.textAlign = 'center';
            kullaniciEtiketi.style.width = Math.round(80 * ortalamaOran) + 'px';
            kullaniciEtiketi.style.transform = 'translateX(-50%) translateZ(0)';
            kullaniciEtiketi.style.willChange = 'transform, left, top';
            kullaniciEtiketi.style.backfaceVisibility = 'hidden';

            document.body.appendChild(karakter);
            document.body.appendChild(kullaniciEtiketi);

            karakter.style.left = '0px';
            karakter.style.top = '0px';
            karakter.style.position = 'absolute';

            // --- Fizik AyarlarÄ± ---
            let yon = Math.random() > 0.5 ? 1 : -1;
            const minAci = AYARLAR.fizik.minimumAci;
            const maxAci = AYARLAR.fizik.maksimumAci;
            let rastgeleTemelAci = (Math.random() * (maxAci - minAci)) + minAci; 
            let rastgeleAci = rastgeleTemelAci * yon; 
            let baslangicHiz = (AYARLAR.fizik.temelHiz + Math.random() * AYARLAR.fizik.hizVaryasyon) * ortalamaOran; 
            const yerCekimi = AYARLAR.fizik.yerCekimi * ortalamaOran;
            const minIvme = AYARLAR.fizik.minimumIvme || 0.01;
            const maxIvme = AYARLAR.fizik.maksimumIvme || 0.05;
            const yatayIvmeMiktari = (Math.random() * (maxIvme - minAci) + minAci) * ortalamaOran; // --- GÃœNCELLENDÄ° (Hata dÃ¼zeltmesi minIvme olacak)
            const maksimumYatayHiz = 18.0 * ortalamaOran;
            const maksimumDikeyHiz = 6.0 * ortalamaOran;
            const guvenliKarakterMargin = Math.round(20 * ortalamaOran);
            const minX = guvenliKarakterMargin;
            const maxX = ekranGenisligi - karakterGenisligi - guvenliKarakterMargin;
            const baslangicX = Math.random() * (maxX - minX) + minX;
            let x = baslangicX;
            let y = -karakterYuksekligi;
            
            // --- GÃœNCELLENDÄ°: Åike Fizik AyarlamasÄ± ---
            // Sekmeyi teÅŸvik etmek iÃ§in daha yatay ve hÄ±zlÄ± fÄ±rlat
            if (isSwitowski) {
                console.log('âœ¨ BÄ°LARDO FÄ°ZÄ°KLERÄ°: HÄ±z ve yatay aÃ§Ä± artÄ±rÄ±lÄ±yor.');
                baslangicHiz = (AYARLAR.fizik.temelHiz + AYARLAR.fizik.hizVaryasyon) * ortalamaOran * 1.5; // %50 daha hÄ±zlÄ±
                rastgeleTemelAci = (Math.random() * (45 - 30)) + 30; // 30-45 derece arasÄ±
                yon = (x > ekranGenisligi / 2) ? -1 : 1; // En yakÄ±n duvara doÄŸru deÄŸil, UZAKTAKÄ° duvara doÄŸru (daha iyi)
                rastgeleAci = rastgeleTemelAci * yon;
            }
            // --- BÄ°TTÄ° ---

            let vx = Math.sin(rastgeleAci * Math.PI / 180) * baslangicHiz;
            let vy = (Math.abs(Math.cos(rastgeleAci * Math.PI / 180) * baslangicHiz));

            console.log(`ğŸ“ Ä°lk pozisyon ayarlanÄ±yor: x=${x}, y=${y}, vx=${vx}, vy=${vy}`);
            karakter.style.transform = `translate3d(${x}px, ${y}px, 0)`;
            kullaniciEtiketi.style.transform = `translate3d(${x + karakterGenisligi/2}px, ${y - 20 * ortalamaOran}px, 0) translateX(-50%)`;
            
            // --- GÃœNCELLENDÄ°: Åike bayraklarÄ± eklendi ---
            karakterPozisyonlari.set(kullaniciAdi, {
                x: x, y: y, vx: vx, vy: vy,
                yatayIvme: yatayIvmeMiktari,
                karakter: karakter, kullaniciEtiketi: kullaniciEtiketi,
                sonCarpismaZamani: 0,
                sonCarpismaKullanici: null,
                isSwitowski: isSwitowski, 
                cheatMode: isSwitowski ? 'bouncing' : 'none', // 'bouncing' (sekme sayar) -> 'guiding' (gÃ¼dÃ¼mlÃ¼)
                cheatBounceTarget: cheatBounceTarget, // Hedef sekme (Ã¶rn: 3)
                cheatBounceCount: 0 // Mevcut sekme
            });
            // --- BÄ°TTÄ° ---

            console.log(`ğŸ“ Karakter pozisyonu kaydedildi: ${kullaniciAdi}`);

            // --- Animasyon DÃ¶ngÃ¼sÃ¼ (requestAnimationFrame) ---
            let sonFrameZamani = 0;
            const hedefFPS = 60;
            const frameSuresi = 1000 / hedefFPS;

            // --- YENÄ°: Sekme sonrasÄ± gecikme bayraÄŸÄ± ---
            let duvardanYeniSekti = false; 

            const animasyon = (mevcutZaman) => {
                if (mevcutZaman - sonFrameZamani < frameSuresi) {
                    requestAnimationFrame(animasyon);
                    return;
                }
                sonFrameZamani = mevcutZaman;
                const mevcutPozisyon = karakterPozisyonlari.get(kullaniciAdi);
                if (!mevcutPozisyon) {
                    return;
                }

                let { x, y, vx, vy } = mevcutPozisyon;
                const deltaTime = 1.0;
                vy += yerCekimi * deltaTime;
                
                // --- GÃœNCELLENDÄ°: Ä°vme, sadece gÃ¼dÃ¼m modunda *deÄŸilse* uygulanÄ±r ---
                if (mevcutPozisyon.cheatMode !== 'guiding') {
                    const ivme = mevcutPozisyon.yatayIvme || 0;
                    if (vx > 0) { vx += ivme * deltaTime; } else if (vx < 0) { vx -= ivme * deltaTime; }
                }
                // --- BÄ°TTÄ° ---

                x += vx * deltaTime;
                y += vy * deltaTime;
                const sinirliHiz = hizSinirla(vx, vy, maksimumYatayHiz, maksimumDikeyHiz);
                vx = sinirliHiz.vx;
                vy = sinirliHiz.vy;

                // --- GÃœNCELLENDÄ°: Duvar Sekme MantÄ±ÄŸÄ± (Åike DesteÄŸi ile) ---
                let duvaraCarpti = false;
                
                if (x <= 0) { // Sol duvar
                    vx = Math.abs(vx); // Her zaman saÄŸa sek
                    x = 0;
                    duvaraCarpti = true;
                } else if (x + karakterGenisligi >= ekranGenisligi) { // SaÄŸ duvar
                    vx = -Math.abs(vx); // Her zaman sola sek
                    x = ekranGenisligi - karakterGenisligi;
                    duvaraCarpti = true;
                }

                // --- YENÄ°: Åike Sekme SayacÄ± ---
                if (duvaraCarpti && !duvardanYeniSekti) { // Sadece bir kez tetiklenmesi iÃ§in
                    if (mevcutPozisyon.isSwitowski && mevcutPozisyon.cheatMode === 'bouncing') {
                        mevcutPozisyon.cheatBounceCount++;
                        console.log(`âœ¨ BÄ°LARDO: Sekme ${mevcutPozisyon.cheatBounceCount} / ${mevcutPozisyon.cheatBounceTarget}`);
                        
                        if (mevcutPozisyon.cheatBounceCount >= mevcutPozisyon.cheatBounceTarget) {
                            mevcutPozisyon.cheatMode = 'guiding';
                            console.log('ğŸ¯ GÃœDÃœMLÃœ MOD AKTÄ°F! Havuz hedefleniyor.');
                        }
                    }
                    
                    // Normal sekme fiziÄŸi (Åike modu 'guiding' DEÄÄ°LSE)
                    if (mevcutPozisyon.cheatMode !== 'guiding') { 
                         const rastgeleSekmeKatsayisi = Math.random() * (1.20 - 0.95) + 0.95;
                         vx *= rastgeleSekmeKatsayisi;
                    }
                    
                    duvardanYeniSekti = true; // Bu frame'de sekti
                } else if (!duvaraCarpti) {
                    duvardanYeniSekti = false; // Duvardan uzaklaÅŸtÄ±, bayraÄŸÄ± sÄ±fÄ±rla
                }
                // --- BÄ°TTÄ° ---

                // --- YENÄ°: Åike GÃ¼dÃ¼m MantÄ±ÄŸÄ± ('guiding' mod aktifse) ---
                if (mevcutPozisyon.isSwitowski && mevcutPozisyon.cheatMode === 'guiding') {
                    const guncelYukseklik_Anim = Math.max(window.innerHeight, document.documentElement.clientHeight) || 1080;
                    const havuzLeft = parseInt(havuz.style.left) || 0;
                    const havuzWidth = parseInt(havuz.style.width) || 298;
                    const targetX = (havuzLeft + havuzWidth / 2) - (karakterGenisligi / 2); // Hedef X
                    
                    const distance = targetX - x; // Hedefe olan yatay mesafe
                    const remainingY = (guncelYukseklik_Anim - karakterYuksekligi) - y; // Yere kalan dikey mesafe

                    if (remainingY > 50) { // Yere Ã§ok yakÄ±n deÄŸilse
                        // Agresif niÅŸan alma katsayÄ±sÄ± (2.0)
                        // Kalan mesafeye (Y) bÃ¶lerek, yaklaÅŸtÄ±kÃ§a daha hÄ±zlÄ± dÃ¼zeltme yapmasÄ±nÄ± saÄŸlar
                        // vy ile Ã§arpmak, hÄ±zÄ± korur
                        let ideal_vx = (distance / remainingY) * (vy * 2.0); 
                        
                        // HÄ±zÄ± yavaÅŸÃ§a ayarla (daha doÄŸal gÃ¶rÃ¼nÃ¼m iÃ§in)
                        vx = vx * 0.95 + ideal_vx * 0.05; 
                    }
                    
                    const hizSinirliGudum = hizSinirla(vx, vy, maksimumYatayHiz, maksimumDikeyHiz);
                    vx = hizSinirliGudum.vx;
                }
                // --- ÅÄ°KE MANTIÄI SONU ---


                const carpismaSonucu = karakterCarpismaTespiti(kullaniciAdi, x, y, karakterGenisligi, karakterYuksekligi);
                if (carpismaSonucu.carpisma && mevcutPozisyon.cheatMode !== 'guiding') { // --- GÃœNCELLENDÄ°: GÃ¼dÃ¼mlÃ¼ modda Ã§arpÄ±ÅŸma olmaz
                    const digerPozisyon = carpismaSonucu.digerPozisyon;
                    const digerKullanici = carpismaSonucu.digerKullanici;
                    const cooldownBitti = (mevcutPozisyon.sonCarpismaKullanici !== digerKullanici) || (mevcutZaman - mevcutPozisyon.sonCarpismaZamani > 500);
                    if (cooldownBitti && digerPozisyon) {
                        const benimMerkezX = x + karakterGenisligi / 2;
                        const digerMerkezX = digerPozisyon.x + karakterGenisligi / 2;
                        const benimMerkezY = y + karakterYuksekligi / 2;
                        const digerMerkezY = digerPozisyon.y + karakterYuksekligi / 2;
                        const farkX = benimMerkezX - digerMerkezX;
                        const farkY = benimMerkezY - digerMerkezY;
                        const toplamYariGenislik = (karakterGenisligi / 2) + (digerPozisyon.karakter.clientWidth / 2);
                        const toplamYariYukseklik = (karakterYuksekligi / 2) + (digerPozisyon.karakter.clientHeight / 2);
                        const overlapX = toplamYariGenislik - Math.abs(farkX);
                        const overlapY = toplamYariYukseklik - Math.abs(farkY);
                        if (overlapX < overlapY) {
                            const benimEskiVx = vx;
                            vx = digerPozisyon.vx;
                            digerPozisyon.vx = benimEskiVx;
                            const itmeMiktari = overlapX + 0.1;
                            if (farkX > 0) { x += itmeMiktari; } else { x -= itmeMiktari; }
                        } else {
                            const benimEskiVy = vy;
                            vy = digerPozisyon.vy;
                            digerPozisyon.vy = benimEskiVy;
                            const itmeMiktari = overlapY + 0.1;
                            if (farkY > 0) { y += itmeMiktari; } else { y -= itmeMiktari; }
                        }
                        mevcutPozisyon.sonCarpismaZamani = mevcutZaman;
                        mevcutPozisyon.sonCarpismaKullanici = digerKullanici;
                        digerPozisyon.sonCarpismaZamani = mevcutZaman;
                        digerPozisyon.sonCarpismaKullanici = kullaniciAdi;
                        const digerSinirliHiz = hizSinirla(digerPozisyon.vx, digerPozisyon.vy, maksimumYatayHiz, maksimumDikeyHiz);
                        digerPozisyon.vx = digerSinirliHiz.vx;
                        digerPozisyon.vy = digerSinirliHiz.vy;
                    }
                }
                mevcutPozisyon.x = x;
                mevcutPozisyon.y = y;
                mevcutPozisyon.vx = vx;
                mevcutPozisyon.vy = vy;
                karakter.style.transform = `translate3d(${Math.round(x)}px, ${Math.round(y)}px, 0)`;
                kullaniciEtiketi.style.transform = `translate3d(${Math.round(x + karakterGenisligi/2)}px, ${Math.round(y - 20 * ortalamaOran)}px, 0) translateX(-50%)`;
                const guncelYukseklik = Math.max(window.innerHeight, document.documentElement.clientHeight) || 1080;
                
                // --- GÃœNCELLENDÄ°: Ä°niÅŸ MantÄ±ÄŸÄ± (Åike DesteÄŸi ile) ---
                if (y + karakterYuksekligi >= guncelYukseklik) {
                    
                    let basariliAtlayis = false;
            
                    // --- YENÄ°: Åike Ä°niÅŸ MantÄ±ÄŸÄ± ---
                    if (mevcutPozisyon.isSwitowski && mevcutPozisyon.cheatMode === 'guiding') {
                        console.log('âœ¨ BÄ°LARDO TAMAMLANDI: Switowski havuzun ortasÄ±na indi!');
                        const havuzLeft = parseInt(havuz.style.left) || 0;
                        const havuzWidth = parseInt(havuz.style.width) || 298;
                        x = (havuzLeft + havuzWidth / 2) - (karakterGenisligi / 2); // Tam merkeze zorla
                        y = guncelYukseklik - karakterYuksekligi;
                        
                        karakter.style.transform = `translate3d(${Math.round(x)}px, ${Math.round(y)}px, 0)`;
                        vy = 0;
                        vx = 0;
                        mevcutPozisyon.x = x; 
                        mevcutPozisyon.y = y;
                        mevcutPozisyon.vx = vx;
                        mevcutPozisyon.vy = vy;
                        
                        basariliAtlayis = true;
                        const puan = 100.0; // MÃ¼kemmel puan
                        
                        if (puan > enYuksekSkor) {
                            enYuksekSkor = puan;
                            enYuksekSkorKullanici = kullaniciAdi;
                            skorGosterici.textContent = `En YÃ¼ksek Skor: ${kullaniciAdi} - ${puan.toFixed(1)}/100`;
                            console.log(`ğŸ‰ YENÄ° REKOR! ${kullaniciAdi}: ${puan} puan`);
                        }
                    } 
                    // --- Normal Ä°niÅŸ MantÄ±ÄŸÄ± ---
                    else {
                        y = guncelYukseklik - karakterYuksekligi;
                        karakter.style.transform = `translate3d(${Math.round(x)}px, ${Math.round(y)}px, 0)`;
                        vy = 0;
                        vx = 0;
                        mevcutPozisyon.y = y; 
                        mevcutPozisyon.vx = vx;
                        mevcutPozisyon.vy = vy;
                        
                        if (!havuzGizli) {
                            const karakterMerkez = x + karakterGenisligi / 2;
                            const havuzLeft = parseInt(havuz.style.left) || 0;
                            const havuzWidth = parseInt(havuz.style.width) || 298;
                            const havuzMerkezi = havuzLeft + havuzWidth / 2;
                            const mesafe = Math.abs(karakterMerkez - havuzMerkezi);
                            const basariMesafeSiniri = AYARLAR.puanlama.basariMesafeSiniri * ortalamaOran;
                            const puanlamaKatsayisi = AYARLAR.puanlama.puanlamaKatsayisi * ortalamaOran;
                            if (mesafe < basariMesafeSiniri) {
                                basariliAtlayis = true;
                                const puan = Math.max(0, Math.min(100, Math.round((basariMesafeSiniri - mesafe) / puanlamaKatsayisi)));
                                console.log(`ğŸ† HAVUZ TUTTURULDU! ${kullaniciAdi} - Puan: ${puan}, Mesafe: ${mesafe.toFixed(1)}`);
                                if (puan > enYuksekSkor) {
                                    enYuksekSkor = puan;
                                    enYuksekSkorKullanici = kullaniciAdi;
                                    skorGosterici.textContent = `En YÃ¼ksek Skor: ${kullaniciAdi} - ${puan.toFixed(1)}/100`;
                                    console.log(`ğŸ‰ YENÄ° REKOR! ${kullaniciAdi}: ${puan} puan`);
                                }
                            } else {
                                console.log(`ğŸ’¥ HAVUZ KAÃ‡IRILDI! ${kullaniciAdi} - Mesafe: ${mesafe.toFixed(1)}`);
                            }
                        } else {
                            console.log('ğŸ’¥ HAVUZ KAÃ‡IRILDI! (Havuz gizliydi)');
                        }
                    }
                    // --- GÃœNCELLEME SONU ---

                    const beklemeSuresi = basariliAtlayis ? 3000 : 100;
                    setTimeout(() => {
                        karakter.style.opacity = '0';
                        kullaniciEtiketi.style.opacity = '0';
                        karakterPozisyonlari.delete(kullaniciAdi);
                        setTimeout(() => {
                            if (karakter.parentNode) karakter.parentNode.removeChild(karakter);
                            if (kullaniciEtiketi.parentNode) kullaniciEtiketi.parentNode.removeChild(kullaniciEtiketi);
                        }, 300);
                    }, beklemeSuresi);
                    return; // Animasyon dÃ¶ngÃ¼sÃ¼nÃ¼ bitir
                }
                // --- Ä°NÄ°Å MANTIÄI SONU ---

                requestAnimationFrame(animasyon);
            };
            requestAnimationFrame(animasyon);
        } // --- atlaAnimasyonunuBaslat sonu ---

        // --- DiÄŸer YardÄ±mcÄ± Fonksiyonlar ---
        function hizSinirla(vx, vy, maksimumYatayHiz, maksimumDikeyHiz) {
            if (Math.abs(vx) > maksimumYatayHiz) { vx = vx > 0 ? maksimumYatayHiz : -maksimumYatayHiz; }
            if (Math.abs(vy) > maksimumDikeyHiz) { vy = vy > 0 ? maksimumDikeyHiz : -maksimumDikeyHiz; }
            return { vx, vy };
        }

        function karakterCarpismaTespiti(mevcutKullanici, x, y, karakterGenisligi, karakterYuksekligi) {
            for (const [kullaniciAdi, pozisyon] of karakterPozisyonlari) {
                if (kullaniciAdi === mevcutKullanici) continue;
                // --- YENÄ°: Åike moduysa Ã§arpÄ±ÅŸma olmaz ---
                if (pozisyon.isSwitowski) continue; 
                // --- BÄ°TTÄ° ---
                const digerX = pozisyon.x;
                const digerY = pozisyon.y;
                const digerGenislik = pozisyon.karakter.clientWidth;
                const digerYukseklik = pozisyon.karakter.clientHeight;
                if (x < digerX + digerGenislik && x + karakterGenisligi > digerX && y < digerY + digerYukseklik && y + karakterYuksekligi > digerY) {
                    return { carpisma: true, digerKullanici: kullaniciAdi, digerPozisyon: pozisyon };
                }
            }
            return { carpisma: false };
        }

        function skorBildirimiGonder(kullaniciAdi, skor) {
            console.log(`ğŸ“¤ Skor bildirimi (gÃ¶nderilmedi): ${kullaniciAdi} - ${skor}/100`);
        }

        function skorBildirimiGoster(kullaniciAdi, skor) {
            // (Bu fonksiyon ÅŸu an kullanÄ±lmÄ±yor ama ileride lazÄ±m olabilir)
        }


        // =================================================================
        // <<< KICK CHAT BAÄLANTISI (MANUEL ID) >>>
        // =================================================================

        function siraIslet() {
            if (atlamaSirasi.length === 0) {
                console.log("âœ… Toplu atlama sÄ±rasÄ± tamamlandÄ±.");
                return;
            }
            const atlayacakKisi = atlamaSirasi.shift(); 
            console.log(`â–¶ï¸ SÄ±radan iÅŸletiliyor: ${atlayacakKisi.username} (Kalan: ${atlamaSirasi.length})`);
            atlaAnimasyonunuBaslat(atlayacakKisi.username, atlayacakKisi.emojiId);
            setTimeout(siraIslet, AYARLAR.topluAtlamaGecikmesi);
        }

        function connectToKickChat(chatroomId) {
            console.log(`Kick sohbet sunucusuna baÄŸlanÄ±lÄ±yor: ${AYARLAR.kickWebSocketUrl}`);
            const ws = new WebSocket(AYARLAR.kickWebSocketUrl);

            ws.onopen = () => {
                console.log("Kick sohbet sunucusuna baÅŸarÄ±yla baÄŸlanÄ±ldÄ±!");
                const subscribeMessage = { event: "pusher:subscribe", data: { channel: `chatrooms.${chatroomId}.v2`, auth: "" } };
                ws.send(JSON.stringify(subscribeMessage));
                console.log(`'${chatroomId}' ID'li odaya abonelik isteÄŸi gÃ¶nderildi.`);
            };

            ws.onmessage = (event) => {
                try {
                    const eventData = JSON.parse(event.data);

                    if (eventData.event === 'pusher:ping') {
                        ws.send(JSON.stringify({ event: 'pusher:pong' }));
                        return;
                    }

                    if (eventData.event === 'App\\Events\\ChatMessageEvent') {
                        const chatMessage = JSON.parse(eventData.data);

                        const username = chatMessage.sender?.username || 'Bilinmeyen';
                        const normalizedUsername = username.toLowerCase();
                        const content = (chatMessage.content || '').trim();
                        const cleanContent = content.toLowerCase();

                        const isYetkili = AYARLAR.yetkiliListesi.includes(normalizedUsername);

                        if (isYetkili) {
                            if (cleanContent === '!topluatla') {
                                topluAtlamaAktif = true;
                                atlamaSirasi = [];
                                console.warn("ğŸŸ¢ TOPLU ATLAMA MODU AÃ‡IK! '!atla' komutlarÄ± sÄ±raya alÄ±nÄ±yor.");
                                return;
                            }

                            if (cleanContent === '!atlat') {
                                if (atlamaSirasi.length === 0) {
                                    console.warn("ğŸŸ¡ '!atlat' komutu alÄ±ndÄ± ama sÄ±ra boÅŸ.");
                                    topluAtlamaAktif = false;
                                    return;
                                }
                                topluAtlamaAktif = false;
                                console.warn(`ğŸ”´ TOPLU ATLAMA MODU KAPALI. ${atlamaSirasi.length} kiÅŸilik sÄ±ra iÅŸletiliyor...`);
                                siraIslet();
                                return;
                            }
                        }

                        if (cleanContent.startsWith('!atla')) {
                            let emojiId = null;
                            const emoteRegex = /\[emote:(\d+):.*?\]/;
                            const match = content.match(emoteRegex);
                            if (match && match[1]) { emojiId = match[1]; }

                            if (topluAtlamaAktif) {
                                atlamaSirasi.push({ username: username, emojiId: emojiId });
                                console.log(`QUEUE: ${username} sÄ±raya eklendi. (SÄ±radaki kiÅŸi: ${atlamaSirasi.length})`);
                            } else {
                                console.log(`ğŸš€ '!atla' komutu algÄ±landÄ±: ${username}`);
                                atlaAnimasyonunuBaslat(username, emojiId);
                            }
                        }
                    }
                } catch (error) {
                    console.error("Sohbet mesajÄ± iÅŸlenirken hata:", error, event.data);
                }
            };

            ws.onclose = () => {
                console.log("Kick sohbet baÄŸlantÄ±sÄ± kesildi. 3 saniye sonra tekrar denenecek.");
                setTimeout(() => connectToKickChat(chatroomId), 3000);
            };

            ws.onerror = (error) => {
                console.error("Kick WebSocket hatasÄ±:", error);
                ws.close();
            };
        }

        // --- Ekran Boyutu ve Test FonksiyonlarÄ± ---
        function ekranBoyutlariniGuncelle() {
            const yeniGenislik = Math.max(window.innerWidth, document.documentElement.clientWidth) || 1920;
            const yeniYukseklik = Math.max(window.innerHeight, document.documentElement.clientHeight) || 1080;
            
            if (yeniGenislik !== ekranGenisligi || yeniYukseklik !== ekranYuksekligi) {
                console.log(`ğŸ“ Ekran boyutu deÄŸiÅŸti: ${yeniGenislik}x${yeniYukseklik}`);
                ekranGenisligi = yeniGenislik;
                ekranYuksekligi = yeniYukseklik;
            }
        }
        window.addEventListener('resize', ekranBoyutlariniGuncelle);
        window.addEventListener('orientationchange', ekranBoyutlariniGuncelle);
        window.testAtla = function(kullaniciAdi = 'TestKullanici', emojiId = null) {
            console.log(`ğŸ§ª Manuel test atlama: ${kullaniciAdi} (Emoji: ${emojiId})`);
            atlaAnimasyonunuBaslat(kullaniciAdi, emojiId);
        };
        // --- YENÄ°: Åike testi iÃ§in Ã¶zel fonksiyon ---
        window.testSike = function() {
            console.log(`ğŸ§ª Manuel BÄ°LARDO testi: switowski`);
            atlaAnimasyonunuBaslat('switowski', null);
        };
        // --- BÄ°TTÄ° ---
        window.havuzPozisyonu = function() { console.log(havuz.getBoundingClientRect()); };
        window.karakterPozisyonlari = function() { console.log(`ğŸ‘¥ Aktif karakterler:`, karakterPozisyonlari.size, karakterPozisyonlari); };

        // =================================================================
        // --- BAÅLATMA FONKSÄ°YONU (MANUEL ID) ---
        // =================================================================
        function baslat() {
            const chatroomId = AYARLAR.kickChatroomID;

            if (chatroomId && chatroomId !== 0) {
                console.log(`Manuel Chatroom ID ${chatroomId} ile baÄŸlanÄ±lÄ±yor...`);
                connectToKickChat(chatroomId);
            } else {
                console.error("!!! BAÅLATMA BAÅARISIZ: Chatroom ID alÄ±namadÄ±.");
                skorGosterici.textContent = `HATA: 'kickChatroomID' ayarlanmamÄ±ÅŸ!`;
                skorGosterici.style.color = "red";
                skorGosterici.style.fontSize = "24px";
            }
        }

        // Sistemi baÅŸlat
        baslat();

    });
    </script>
    </body>

</html>

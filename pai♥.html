<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="6viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlama Animasyonu</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: transparent;
            font-family: 'Roboto', sans-serif;
            /* OBS optimizasyonu */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeSpeed;
            /* GPU hızlandırma */
            transform: translateZ(0);
            backface-visibility: hidden;
            /* OBS için optimize edilmiş rendering */
            image-rendering: optimizeSpeed;
            image-rendering: -webkit-optimize-contrast;
            /* SVG optimizasyonu */
            image-rendering: crisp-edges;
            image-rendering: pixelated;
        }

        body {
            position: relative;
            min-width: 100vw;
            min-height: 100vh;
        }

        .karakter {
            width: 100px;
            height: 120px;
            background-image: url('karakter.png');
            background-size: 100px 120px;
            background-repeat: no-repeat;
            background-position: center;
            position: absolute;
            top: -150px;
            left: -150px;
            opacity: 0;
            z-index: 10; 
            transition: opacity 0.3s ease; 
            will-change: transform;
            transform: translateZ(0);
        }

        #havuz {
            width: 298px;
            height: 83px;
            background-image: url('havuz.svg'), url('havuz.png');
            background-size: 298px 83px;
            background-repeat: no-repeat;
            background-position: center;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateZ(0);
            box-sizing: border-box;
            transition: opacity 0.5s ease;
            z-index: 5;
            will-change: transform, opacity;
            backface-visibility: hidden;
            image-rendering: optimizeSpeed;
            image-rendering: crisp-edges;
        }
    </style>
    </head>

<body>
    <div id="havuz"></div>

    <audio id="atlama-sesi" preload="auto" style="display: none;">
        <source src="vada.mp3" type="audio/mpeg">
    </audio>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const havuz = document.getElementById('havuz');
        const atlamaSesi = document.getElementById('atlama-sesi');

        // =================================================================
        // === AYAR KUTUSU (CONFIG) ===
        // =================================================================
        const AYARLAR = {
            // --- KICK AYARLARI ---
            kickChatroomID: 24986517, 
            kickWebSocketUrl: "wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=7.6.0&flash=false", 
            // --- YETKİLİ AYARLARI ---
            yetkiliListesi: ["pairaaa", "youarerightpaira", "himilayk"],
            topluAtlamaGecikmesi: 100, 
            // --- KARAKTER GRUPLARI ---
            ozelKarakterGruplari: {
                'grup1': { resim: '1.png', kullanicilar: ['kullanici1', 'kullanici2', 'testuser'] },
                'grup2': { resim: '2.png', kullanicilar: ['baska_biri', 'deneme'] },
                'grup3': { resim: '3.png', kullanicilar: [] }
            },
            // --- DİĞER AYARLAR ---
            testModu: false,
            fizik: {
                yerCekimi: 0.05,
                temelHiz: 3,
                hizVaryasyon: 1.5,
                minimumAci: 15,
                maksimumAci: 60,
                minimumIvme: 0.66,
                maksimumIvme: 1
            },
            puanlama: {
                basariMesafeSiniri: 135,
                puanlamaKatsayisi: 1.35
            }
        };
        // =================================================================
        // === AYAR KUTUSU SONU ===
        // =================================================================

        let ekranGenisligi = Math.max(window.innerWidth, document.documentElement.clientWidth) || 1920; 
        let ekranYuksekligi = Math.max(window.innerHeight, document.documentElement.clientHeight) || 1080;
        console.log(`📏 Ekran boyutları algılandı: ${ekranGenisligi}x${ekranYuksekligi}`);
        const temelEkranGenisligi = 1920;
        const temelEkranYuksekligi = 1080;
        const genislikOran = ekranGenisligi / temelEkranGenisligi;
        const yukseklikOran = ekranYuksekligi / temelEkranYuksekligi;
        const ortalamaOran = (genislikOran + yukseklikOran) / 2;
        console.log(`📐 Ekran ölçeklendirme: Oran: ${ortalamaOran.toFixed(2)}`);
        document.body.style.imageRendering = 'optimizeSpeed';
        document.body.style.imageRendering = '-webkit-optimize-contrast';
        console.log('🎥 OBS optimizasyonu aktif');

        let havuzGizli = false;
        let havuzGizlemeTimer = null;
        let atlayanKullanicilar = new Set();
        let karakterPozisyonlari = new Map();
        let enYuksekSkor = 0;
        let enYuksekSkorKullanici = '';
        let topluAtlamaAktif = false;
        let atlamaSirasi = [];

        const skorGosterici = document.createElement('div');
        skorGosterici.id = 'skor-gosterici';
        skorGosterici.style.position = 'fixed';
        skorGosterici.style.bottom = '10px';
        skorGosterici.style.left = '10px';
        skorGosterici.style.color = '#C8A2C8';
        skorGosterici.style.fontSize = '16px';
        skorGosterici.style.fontWeight = '500';
        skorGosterici.style.fontFamily = "'Roboto', sans-serif";
        skorGosterici.style.textShadow = '2px 2px 4px black';
        skorGosterici.style.zIndex = '100';
        skorGosterici.style.pointerEvents = 'none';
        skorGosterici.textContent = 'En Yüksek Skor: Henüz yok';
        document.body.appendChild(skorGosterici);

        function rastgeleHavuzKonumu() {
            const guncelGenislik = Math.max(window.innerWidth, document.documentElement.clientWidth) || 1920;
            const havuzGenisligi = Math.round(298 * ortalamaOran);
            const havuzYuksekligi = Math.round(83 * ortalamaOran);
            const guvenliMargin = Math.round(50 * ortalamaOran);
            const solSinir = guvenliMargin;
            const sagSinir = guncelGenislik - havuzGenisligi - guvenliMargin;
            const gercekSolSinir = Math.min(solSinir, sagSinir);
            const gercekSagSinir = Math.max(solSinir, sagSinir);
            const rastgeleX = Math.random() * (gercekSagSinir - gercekSolSinir) + gercekSolSinir;
            havuz.style.left = rastgeleX + 'px';
            havuz.style.transform = 'none';
            havuz.style.opacity = '1';
            havuz.style.width = havuzGenisligi + 'px';
            havuz.style.height = havuzYuksekligi + 'px';
            havuz.style.backgroundSize = havuzGenisligi + 'px ' + havuzYuksekligi + 'px';
            havuzGizli = false;
            atlayanKullanicilar.clear();
            if (havuzGizlemeTimer) {
                clearTimeout(havuzGizlemeTimer);
                havuzGizlemeTimer = null;
            }
            console.log(`Havuz konumu: x=${rastgeleX}`);
        }

        rastgeleHavuzKonumu();

        function atlaAnimasyonunuBaslat(kullaniciAdi = 'Bilinmeyen', emojiId = null) {
            const aktifKarakterSayisi = document.querySelectorAll('.karakter').length;
            if (aktifKarakterSayisi > 6) {
                console.log(`⚠️ OBS optimizasyonu: Çok fazla aktif karakter (${aktifKarakterSayisi}), yeni atlama reddediliyor`);
                return;
            }
            if (!havuzGizli && atlayanKullanicilar.has(kullaniciAdi) && !topluAtlamaAktif) {
                console.log(`Bloklandi: ${kullaniciAdi} zaten atladi.`);
                return;
            }
            if (havuzGizli) { rastgeleHavuzKonumu(); }
            atlayanKullanicilar.add(kullaniciAdi);

            if (atlamaSesi) {
                atlamaSesi.volume = 0.48;
                atlamaSesi.playbackRate = 1.6;
                atlamaSesi.currentTime = 0;
                atlamaSesi.play().catch(error => { console.warn("Ses oynatılamadı:", error); });
            }

            if (havuzGizlemeTimer) { clearTimeout(havuzGizlemeTimer); }
            havuzGizlemeTimer = setTimeout(() => {
                havuz.style.opacity = '0';
                havuzGizli = true;
                console.log('Havuz gizlendi - uzun süre atlama olmadı');
            }, 30000);

            const karakter = document.createElement('div');
            karakter.className = 'karakter';
            console.log(`🎨 Karakter elementi oluşturuldu: ${kullaniciAdi}`);

            let karakterGenisligi;
            let karakterYuksekligi;
            const emojiUrl = emojiId ? `https://files.kick.com/emotes/${emojiId}/fullsize` : null;
            let karakterBulundu = false;
            const normalizedUsername = kullaniciAdi.toLowerCase();

            // --- YENİ: 3 Sekmeli Şike Tespiti ---
            const isSwitowski = normalizedUsername === 'switowski';
            let cheatMode = 'none';
            let cheatTargetWallX = 0; // Hedef duvarın X koordinatı
            const cheatBounceTarget = 3; // İstenen sekme sayısı
            let cheatBounceCount = 0;
            // --- BİTTİ ---

            if (isSwitowski) {
                karakter.style.backgroundImage = "url('karakter.svg'), url('karakter.png')";
                karakterGenisligi = Math.round(90 * ortalamaOran);
                karakterYuksekligi = Math.round(108 * ortalamaOran);
                karakterBulundu = true;
                cheatMode = 'aimingForWall'; // Faz 1'i başlat
                console.log(`✨ 3 SEKMELİ ŞİKE AKTİF: Faz 1 - Duvar hedefleniyor... (Hedef: ${cheatBounceTarget} sekme)`);
            } else if (normalizedUsername === 'pairaaa') {
                karakter.style.backgroundImage = "url('pairaaa.svg'), url('pairaaa.png')";
                karakterGenisligi = Math.round(90 * ortalamaOran);
                karakterYuksekligi = Math.round(108 * ortalamaOran);
                console.log(`🌟 ${kullaniciAdi} - Özel karakter kullanılıyor!`);
                karakterBulundu = true;
            } else if (normalizedUsername === 'himilayk') {
                karakter.style.backgroundImage = "url('himilayk.svg'), url('himilayk.png')";
                karakterGenisligi = Math.round(90 * ortalamaOran);
                karakterYuksekligi = Math.round(108 * ortalamaOran);
                console.log(`🌟 ${kullaniciAdi} - Özel karakter kullanılıyor!`);
                karakterBulundu = true;
            }

            if (!karakterBulundu) {
                for (const grup of Object.values(AYARLAR.ozelKarakterGruplari)) {
                    const kucukHarfKullanicilar = grup.kullanicilar.map(u => u.toLowerCase());
                    if (kucukHarfKullanicilar.includes(normalizedUsername)) {
                        karakter.style.backgroundImage = `url('${grup.resim}')`;
                        karakterGenisligi = Math.round(90 * ortalamaOran);
                        karakterYuksekligi = Math.round(108 * ortalamaOran);
                        console.log(`👥 ${kullaniciAdi} - '${grup.resim}' grup karakteri kullanılıyor!`);
                        karakterBulundu = true;
                        break;
                    }
                }
            }
            if (!karakterBulundu && emojiUrl) {
                karakter.style.backgroundImage = `url('${emojiUrl}')`;
                karakterGenisligi = Math.round(80 * ortalamaOran);
                karakterYuksekligi = Math.round(80 * ortalamaOran);
                console.log(`🎨 ${kullaniciAdi} - Emoji karakteri kullanılıyor: ${emojiId}`);
                karakterBulundu = true;
            }
            if (!karakterBulundu) {
                karakter.style.backgroundImage = "url('karakter.svg'), url('karakter.png')";
                karakterGenisligi = Math.round(90 * ortalamaOran);
                karakterYuksekligi = Math.round(108 * ortalamaOran);
            }

            karakter.style.width = karakterGenisligi + 'px';
            karakter.style.height = karakterYuksekligi + 'px';
            karakter.style.backgroundSize = karakterGenisligi + 'px ' + karakterYuksekligi + 'px';
            karakter.style.backgroundRepeat = 'no-repeat';
            karakter.style.backgroundPosition = 'center';
            karakter.style.position = 'absolute';
            karakter.style.zIndex = '20';
            karakter.style.opacity = '1';
            karakter.style.willChange = 'transform, left, top';
            karakter.style.transform = 'translateZ(0)';
            karakter.style.backfaceVisibility = 'hidden';

            const kullaniciEtiketi = document.createElement('div');
            kullaniciEtiketi.className = 'kullanici-etiketi';
            kullaniciEtiketi.textContent = kullaniciAdi;
            kullaniciEtiketi.style.position = 'absolute';
            kullaniciEtiketi.style.left = '0px';
            kullaniciEtiketi.style.top = '0px';
            kullaniciEtiketi.style.color = '#C8A2C8';
            kullaniciEtiketi.style.fontSize = '16px';
            kullaniciEtiketi.style.fontWeight = '400';
            kullaniciEtiketi.style.fontFamily = "'Roboto', sans-serif";
            kullaniciEtiketi.style.zIndex = '11';
            kullaniciEtiketi.style.pointerEvents = 'none';
            kullaniciEtiketi.style.textAlign = 'center';
            kullaniciEtiketi.style.width = Math.round(80 * ortalamaOran) + 'px';
            kullaniciEtiketi.style.transform = 'translateX(-50%) translateZ(0)';
            kullaniciEtiketi.style.willChange = 'transform, left, top';
            kullaniciEtiketi.style.backfaceVisibility = 'hidden';

            document.body.appendChild(karakter);
            document.body.appendChild(kullaniciEtiketi);

            karakter.style.left = '0px';
            karakter.style.top = '0px';
            karakter.style.position = 'absolute';

            // --- Fizik Ayarları ---
            let yon = Math.random() > 0.5 ? 1 : -1;
            const minAci = AYARLAR.fizik.minimumAci;
            const maxAci = AYARLAR.fizik.maksimumAci;
            let rastgeleTemelAci = (Math.random() * (maxAci - minAci)) + minAci;
            let baslangicHiz = (AYARLAR.fizik.temelHiz + Math.random() * AYARLAR.fizik.hizVaryasyon) * ortalamaOran;
            const yerCekimi = AYARLAR.fizik.yerCekimi * ortalamaOran;
            const minIvme = AYARLAR.fizik.minimumIvme || 0.01;
            const maxIvme = AYARLAR.fizik.maksimumIvme || 0.05;
            
            const yatayIvmeMiktari = isSwitowski ? 0 : (Math.random() * (maxIvme - minIvme) + minIvme) * ortalamaOran;

            const maksimumYatayHiz = 18.0 * ortalamaOran;
            const maksimumDikeyHiz = 6.0 * ortalamaOran;
            const guvenliKarakterMargin = Math.round(20 * ortalamaOran);
            const minX = guvenliKarakterMargin;
            const maxX = ekranGenisligi - karakterGenisligi - guvenliKarakterMargin;
            const baslangicX = Math.random() * (maxX - minX) + minX;
            let x = baslangicX;
            let y = -karakterYuksekligi;

            // --- GÜNCELLENDİ: Şike Başlangıç Fiziği ---
            if (isSwitowski) {
                // Duvara ulaşması için daha hızlı ve yatay fırlat
                baslangicHiz = (AYARLAR.fizik.temelHiz + AYARLAR.fizik.hizVaryasyon) * ortalamaOran * 1.5; // %50 daha hızlı
                rastgeleTemelAci = (Math.random() * (45 - 30)) + 30; // 30-45 derece (daha yatay)
                
                // En uzak duvarı hedefle
                if (x > ekranGenisligi / 2) { // Sağda doğdu, solu hedefle
                    yon = -1;
                    cheatTargetWallX = 0;
                } else { // Solda doğdu, sağı hedefle
                    yon = 1;
                    cheatTargetWallX = ekranGenisligi - karakterGenisligi;
                }
                console.log(`✨ FAZ 1: Hedef duvar X=${cheatTargetWallX}`);
            }
            // --- BİTTİ ---

            let rastgeleAci = rastgeleTemelAci * yon;
            let vx = Math.sin(rastgeleAci * Math.PI / 180) * baslangicHiz;
            let vy = (Math.abs(Math.cos(rastgeleAci * Math.PI / 180) * baslangicHiz));

            console.log(`📍 İlk pozisyon ayarlanıyor: x=${x}, y=${y}, vx=${vx}, vy=${vy}`);
            karakter.style.transform = `translate3d(${x}px, ${y}px, 0)`;
            kullaniciEtiketi.style.transform = `translate3d(${x + karakterGenisligi/2}px, ${y - 20 * ortalamaOran}px, 0) translateX(-50%)`;
            
            // --- YENİ: Şike Sayaçları ---
            karakterPozisyonlari.set(kullaniciAdi, {
                x: x, y: y, vx: vx, vy: vy,
                yatayIvme: yatayIvmeMiktari,
                karakter: karakter, kullaniciEtiketi: kullaniciEtiketi,
                sonCarpismaZamani: 0,
                sonCarpismaKullanici: null,
                isSwitowski: isSwitowski,
                cheatMode: cheatMode, // 'aimingForWall' veya 'guidingToPool'
                cheatTargetWallX: cheatTargetWallX, // Hedef duvarın X'i
                cheatBounceTarget: cheatBounceTarget, // Hedef sekme sayısı (3)
                cheatBounceCount: cheatBounceCount // Mevcut sekme sayısı (0)
            });
            // --- BİTTİ ---

            console.log(`📝 Karakter pozisyonu kaydedildi: ${kullaniciAdi}`);

            let sonFrameZamani = 0;
            const hedefFPS = 60;
            const frameSuresi = 1000 / hedefFPS;

            const animasyon = (mevcutZaman) => {
                if (mevcutZaman - sonFrameZamani < frameSuresi) {
                    requestAnimationFrame(animasyon);
                    return;
                }
                sonFrameZamani = mevcutZaman;
                const mevcutPozisyon = karakterPozisyonlari.get(kullaniciAdi);
                if (!mevcutPozisyon) {
                    return;
                }

                let { x, y, vx, vy } = mevcutPozisyon;
                const deltaTime = 1.0;
                
                // --- DÜZELTİLDİ: Fizik Çekirdeği (3 SEKMELİ SİSTEM) ---

                // 1. Dikey Hız (Yerçekimi HER ZAMAN aktif)
                vy += yerCekimi * deltaTime;

                // 2. Yatay Hız (Şike veya Normal Fizik)
                if (mevcutPozisyon.isSwitowski) {
                    // --- FAZLI YÖRÜNGE BÜKÜCÜ ---
                    let targetX;
                    
                    if (mevcutPozisyon.cheatMode === 'aimingForWall') {
                        // Faz 1: Hedefimiz mevcut hedef duvar
                        targetX = mevcutPozisyon.cheatTargetWallX;
                    } else {
                        // Faz 2: Hedefimiz havuzun merkezi
                        const havuzLeft = parseInt(havuz.style.left) || 0;
                        const havuzWidth = parseInt(havuz.style.width) || 298;
                        targetX = (havuzLeft + havuzWidth / 2) - (karakterGenisligi / 2);
                    }

                    // --- Akıllı Yönlendirme (Her iki fazda da çalışır) ---
                    const guncelYukseklik_Anim = Math.max(window.innerHeight, document.documentElement.clientHeight) || 1080;
                    const distance = targetX - x;
                    const remainingY = (guncelYukseklik_Anim - karakterYuksekligi) - y;

                    if (remainingY > 50) { // Yere çok yakın değilse
                        const timeToImpact = (remainingY / (vy + 0.001)) || 0.1;
                        let ideal_vx = distance / (timeToImpact + 0.001);

                        // Yumuşatma faktörü (%15). Ani eğim değişikliğini engeller.
                        vx = (vx * 0.85) + (ideal_vx * 0.15);
                    }
                    // --- BİTTİ ---

                } else {
                    // --- NORMAL FİZİK ---
                    const ivme = mevcutPozisyon.yatayIvme || 0;
                    if (vx > 0) { vx += ivme * deltaTime; } else if (vx < 0) { vx -= ivme * deltaTime; }
                }

                // 3. Hızları Uygula
                x += vx * deltaTime;
                y += vy * deltaTime;
                
                // 4. Hızları Sınırla
                const sinirliHiz = hizSinirla(vx, vy, maksimumYatayHiz, maksimumDikeyHiz);
                vx = sinirliHiz.vx;
                vy = sinirliHiz.vy;

                // 5. Duvar Sekmesi (Tüm karakterler için)
                let bounced = false;
                if (x <= 0) {
                    vx = Math.abs(vx); // Her zaman sağa sek
                    x = 0;
                    bounced = true;
                } else if (x + karakterGenisligi >= ekranGenisligi) {
                    vx = -Math.abs(vx); // Her zaman sola sek
                    x = ekranGenisligi - karakterGenisligi;
                    bounced = true;
                }

                // 6. Sekme Sonrası Ayarlama (ŞİKE SAYACI BURADA)
                if (bounced) {
                    if (mevcutPozisyon.isSwitowski) {
                        
                        if (mevcutPozisyon.cheatMode === 'aimingForWall') {
                            mevcutPozisyon.cheatBounceCount++;
                            console.log(`✨ 3 SEKMELİ ŞİKE: Sekme ${mevcutPozisyon.cheatBounceCount} / ${mevcutPozisyon.cheatBounceTarget}`);

                            // Hedef sayısına ulaştık mı?
                            if (mevcutPozisyon.cheatBounceCount >= mevcutPozisyon.cheatBounceTarget) {
                                // Evet: Faz 2'ye geç
                                mevcutPozisyon.cheatMode = 'guidingToPool';
                                console.log('✨ FAZ 2: Hedef sekme sayısına ulaşıldı! Havuz hedefleniyor.');
                            } else {
                                // Hayır: Karşı duvarı hedefle
                                if (x === 0) { // Sol duvara çarptı, sağı hedefle
                                    mevcutPozisyon.cheatTargetWallX = ekranGenisligi - karakterGenisligi;
                                } else { // Sağ duvara çarptı, solu hedefle
                                    mevcutPozisyon.cheatTargetWallX = 0;
                                }
                                console.log(`✨ FAZ 1: Yeni hedef duvar X=${mevcutPozisyon.cheatTargetWallX}`);
                            }
                        }
                        
                        // Şike sekmesi (hafifçe daha hızlı, "havalı" görünmesi için)
                        vx *= 1.1; 
                    } else {
                        // Normal rastgele sekme
                        const rastgeleSekmeKatsayisi = Math.random() * (1.20 - 0.95) + 0.95;
                        vx *= rastgeleSekmeKatsayisi;
                    }
                }
                // --- FİZİK ÇEKİRDEĞİ SONU ---


                // 7. Çarpışma Tespiti (Switowski hariç)
                if (!mevcutPozisyon.isSwitowski) {
                    const carpismaSonucu = karakterCarpismaTespiti(kullaniciAdi, x, y, karakterGenisligi, karakterYuksekligi);
                    if (carpismaSonucu.carpisma) {
                        // ... (Çarpışma kodu - değişiklik yok) ...
                        const digerPozisyon = carpismaSonucu.digerPozisyon;
                        const digerKullanici = carpismaSonucu.digerKullanici;
                        const cooldownBitti = (mevcutPozisyon.sonCarpismaKullanici !== digerKullanici) || (mevcutZaman - mevcutPozisyon.sonCarpismaZamani > 500);
                        if (cooldownBitti && digerPozisyon) {
                            const benimMerkezX = x + karakterGenisligi / 2;
                            const digerMerkezX = digerPozisyon.x + karakterGenisligi / 2;
                            const benimMerkezY = y + karakterYuksekligi / 2;
                            const digerMerkezY = digerPozisyon.y + karakterYuksekligi / 2;
                            const farkX = benimMerkezX - digerMerkezX;
                            const farkY = benimMerkezY - digerMerkezY;
                            const toplamYariGenislik = (karakterGenisligi / 2) + (digerPozisyon.karakter.clientWidth / 2);
                            const toplamYariYukseklik = (karakterYuksekligi / 2) + (digerPozisyon.karakter.clientHeight / 2);
                            const overlapX = toplamYariGenislik - Math.abs(farkX);
                            const overlapY = toplamYariYukseklik - Math.abs(farkY);
                            if (overlapX < overlapY) {
                                const benimEskiVx = vx;
                                vx = digerPozisyon.vx;
                                digerPozisyon.vx = benimEskiVx;
                                const itmeMiktari = overlapX + 0.1;
                                if (farkX > 0) { x += itmeMiktari; } else { x -= itmeMiktari; }
                            } else {
                                const benimEskiVy = vy;
                                vy = digerPozisyon.vy;
                                digerPozisyon.vy = benimEskiVy;
                                const itmeMiktari = overlapY + 0.1;
                                if (farkY > 0) { y += itmeMiktari; } else { y -= itmeMiktari; }
                            }
                            mevcutPozisyon.sonCarpismaZamani = mevcutZaman;
                            mevcutPozisyon.sonCarpismaKullanici = digerKullanici;
                            digerPozisyon.sonCarpismaZamani = mevcutZaman;
                            digerPozisyon.sonCarpismaKullanici = kullaniciAdi;
                            const digerSinirliHiz = hizSinirla(digerPozisyon.vx, digerPozisyon.vy, maksimumYatayHiz, maksimumDikeyHiz);
                            digerPozisyon.vx = digerSinirliHiz.vx;
                            digerPozisyon.vy = digerSinirliHiz.vy;
                        }
                    }
                }
                
                // 8. Pozisyonu Güncelle
                mevcutPozisyon.x = x;
                mevcutPozisyon.y = y;
                mevcutPozisyon.vx = vx;
                mevcutPozisyon.vy = vy;
                karakter.style.transform = `translate3d(${Math.round(x)}px, ${Math.round(y)}px, 0)`;
                kullaniciEtiketi.style.transform = `translate3d(${Math.round(x + karakterGenisligi/2)}px, ${Math.round(y - 20 * ortalamaOran)}px, 0) translateX(-50%)`;
                
                // 9. İniş Tespiti
                const guncelYukseklik = Math.max(window.innerHeight, document.documentElement.clientHeight) || 1080;
                if (y + karakterYuksekligi >= guncelYukseklik) {
                    
                    let basariliAtlayis = false;
            
                    // --- DÜZELTİLDİ: Şike İniş Mantığı ---
                    // Sadece Faz 2'ye geçtiyse (yani 3 sekme olduysa) puan ver
                    if (mevcutPozisyon.isSwitowski && mevcutPozisyon.cheatMode === 'guidingToPool') {
                        console.log('✨ 3 SEKMELİ ŞİKE TAMAMLANDI: Switowski havuzun ortasına indi!');
                        const havuzLeft = parseInt(havuz.style.left) || 0;
                        const havuzWidth = parseInt(havuz.style.width) || 298;
                        const hedefX = (havuzLeft + havuzWidth / 2) - (karakterGenisligi / 2); // Tam merkez
                        x = hedefX; // Tam merkeze zorla (Snap)
                        y = guncelYukseklik - karakterYuksekligi;
                        
                        karakter.style.transform = `translate3d(${Math.round(x)}px, ${Math.round(y)}px, 0)`;
                        vy = 0;
                        vx = 0;
                        mevcutPozisyon.x = x; 
                        mevcutPozisyon.y = y;
                        mevcutPozisyon.vx = vx;
                        mevcutPozisyon.vy = vy;
                        
                        basariliAtlayis = true;
                        const puan = 100.0; // Mükemmel puan
                        
                        if (puan > enYuksekSkor) {
                            enYuksekSkor = puan;
                            enYuksekSkorKullanici = kullaniciAdi;
                            skorGosterici.textContent = `En Yüksek Skor: ${kullaniciAdi} - ${puan.toFixed(1)}/100`;
                            console.log(`🎉 YENİ REKOR! ${kullaniciAdi}: ${puan} puan`);
                        }
                    } 
                    // --- Normal İniş Mantığı (veya başarısız şike) ---
                    else {
                        y = guncelYukseklik - karakterYuksekligi;
                        karakter.style.transform = `translate3d(${Math.round(x)}px, ${Math.round(y)}px, 0)`;
                        vy = 0;
                        vx = 0;
                        mevcutPozisyon.y = y; 
                        mevcutPozisyon.vx = vx;
                        mevcutPozisyon.vy = vy;
                        
                        if (mevcutPozisyon.isSwitowski) { // Eğer Faz 1'deyken yere çarptıysa (3 sekmeyi tamamlayamadıysa)
                             console.log(`💥 3 SEKMELİ ŞİKE BAŞARISIZ! (Sadece ${mevcutPozisyon.cheatBounceCount} sekme yapabildi)`);
                        }

                        if (!havuzGizli) {
                            const karakterMerkez = x + karakterGenisligi / 2;
                            const havuzLeft = parseInt(havuz.style.left) || 0;
                            const havuzWidth = parseInt(havuz.style.width) || 298;
                            const havuzMerkezi = havuzLeft + havuzWidth / 2;
                            const mesafe = Math.abs(karakterMerkez - havuzMerkezi);
                            const basariMesafeSiniri = AYARLAR.puanlama.basariMesafeSiniri * ortalamaOran;
                            const puanlamaKatsayisi = AYARLAR.puanlama.puanlamaKatsayisi * ortalamaOran;
                            if (mesafe < basariMesafeSiniri) {
                                basariliAtlayis = true;
                                const puan = Math.max(0, Math.min(100, Math.round((basariMesafeSiniri - mesafe) / puanlamaKatsayisi)));
                                console.log(`🏆 HAVUZ TUTTURULDU! ${kullaniciAdi} - Puan: ${puan}, Mesafe: ${mesafe.toFixed(1)}`);
                                if (puan > enYuksekSkor && !mevcutPozisyon.isSwitowski) { // Şike rekor sayılmaz
                                    enYuksekSkor = puan;
                                    enYuksekSkorKullanici = kullaniciAdi;
                                    skorGosterici.textContent = `En Yüksek Skor: ${kullaniciAdi} - ${puan.toFixed(1)}/100`;
                                    console.log(`🎉 YENİ REKOR! ${kullaniciAdi}: ${puan} puan`);
                                }
                            } else {
                                console.log(`💥 HAVUZ KAÇIRILDI! ${kullaniciAdi} - Mesafe: ${mesafe.toFixed(1)}`);
                            }
                        } else {
                            console.log('💥 HAVUZ KAÇIRILDI! (Havuz gizliydi)');
                        }
                    }
                    // --- GÜNCELLEME SONU ---

                    const beklemeSuresi = basariliAtlayis ? 3000 : 100;
                    setTimeout(() => {
                        karakter.style.opacity = '0';
                        kullaniciEtiketi.style.opacity = '0';
                        karakterPozisyonlari.delete(kullaniciAdi);
                        setTimeout(() => {
                            if (karakter.parentNode) karakter.parentNode.removeChild(karakter);
                            if (kullaniciEtiketi.parentNode) kullaniciEtiketi.parentNode.removeChild(kullaniciEtiketi);
                        }, 300);
                    }, beklemeSuresi);
                    return; // Animasyon döngüsünü bitir
                }
                requestAnimationFrame(animasyon);
            };
            requestAnimationFrame(animasyon);
        } // --- atlaAnimasyonunuBaslat sonu ---

        // --- Diğer Yardımcı Fonksiyonlar ---
        function hizSinirla(vx, vy, maksimumYatayHiz, maksimumDikeyHiz) {
            if (Math.abs(vx) > maksimumYatayHiz) { vx = vx > 0 ? maksimumYatayHiz : -maksimumYatayHiz; }
            if (Math.abs(vy) > maksimumDikeyHiz) { vy = vy > 0 ? maksimumDikeyHiz : -maksimumDikeyHiz; }
            return { vx, vy };
        }

        function karakterCarpismaTespiti(mevcutKullanici, x, y, karakterGenisligi, karakterYuksekligi) {
            for (const [kullaniciAdi, pozisyon] of karakterPozisyonlari) {
                if (kullaniciAdi === mevcutKullanici) continue;
                if (pozisyon.isSwitowski) continue; // Switowski'ye kimse çarpamaz
                
                const digerX = pozisyon.x;
                const digerY = pozisyon.y;
                const digerGenislik = pozisyon.karakter.clientWidth;
                const digerYukseklik = pozisyon.karakter.clientHeight;
                if (x < digerX + digerGenislik && x + karakterGenisligi > digerX && y < digerY + digerYukseklik && y + karakterYuksekligi > digerY) {
                    return { carpisma: true, digerKullanici: kullaniciAdi, digerPozisyon: pozisyon };
                }
            }
            return { carpisma: false };
        }

        function skorBildirimiGonder(kullaniciAdi, skor) {
            console.log(`📤 Skor bildirimi (gönderilmedi): ${kullaniciAdi} - ${skor}/100`);
        }

        function skorBildirimiGoster(kullaniciAdi, skor) {
            // (Kullanılmıyor)
        }

        // =================================================================
        // <<< KICK CHAT BAĞLANTISI (MANUEL ID) >>>
        // =================================================================

        function siraIslet() {
            if (atlamaSirasi.length === 0) {
                console.log("✅ Toplu atlama sırası tamamlandı.");
                return;
            }
            const atlayacakKisi = atlamaSirasi.shift(); 
            console.log(`▶️ Sıradan işletiliyor: ${atlayacakKisi.username} (Kalan: ${atlamaSirasi.length})`);
            atlaAnimasyonunuBaslat(atlayacakKisi.username, atlayacakKisi.emojiId);
            setTimeout(siraIslet, AYARLAR.topluAtlamaGecikmesi);
        }

        function connectToKickChat(chatroomId) {
            console.log(`Kick sohbet sunucusuna bağlanılıyor: ${AYARLAR.kickWebSocketUrl}`);
            const ws = new WebSocket(AYARLAR.kickWebSocketUrl);

            ws.onopen = () => {
                console.log("Kick sohbet sunucusuna başarıyla bağlanıldı!");
                const subscribeMessage = { event: "pusher:subscribe", data: { channel: `chatrooms.${chatroomId}.v2`, auth: "" } };
                ws.send(JSON.stringify(subscribeMessage));
                console.log(`'${chatroomId}' ID'li odaya abonelik isteği gönderildi.`);
            };

            ws.onmessage = (event) => {
                try {
                    const eventData = JSON.parse(event.data);
                    if (eventData.event === 'pusher:ping') {
                        ws.send(JSON.stringify({ event: 'pusher:pong' }));
                        return;
                    }
                    if (eventData.event === 'App\\Events\\ChatMessageEvent') {
                        const chatMessage = JSON.parse(eventData.data);
                        const username = chatMessage.sender?.username || 'Bilinmeyen';
                        const normalizedUsername = username.toLowerCase();
                        const content = (chatMessage.content || '').trim();
                        const cleanContent = content.toLowerCase();
                        const isYetkili = AYARLAR.yetkiliListesi.includes(normalizedUsername);

                        if (isYetkili) {
                            if (cleanContent === '!topluatla') {
                                topluAtlamaAktif = true;
                                atlamaSirasi = [];
                                console.warn("🟢 TOPLU ATLAMA MODU AÇIK! '!atla' komutları sıraya alınıyor.");
                                return;
                            }
                            if (cleanContent === '!atlat') {
                                if (atlamaSirasi.length === 0) {
                                    console.warn("🟡 '!atlat' komutu alındı ama sıra boş.");
                                    topluAtlamaAktif = false;
                                    return;
                                }
                                topluAtlamaAktif = false;
                                console.warn(`🔴 TOPLU ATLAMA MODU KAPALI. ${atlamaSirasi.length} kişilik sıra işletiliyor...`);
                                siraIslet();
                                return;
                            }
                        }

                        if (cleanContent.startsWith('!atla')) {
                            let emojiId = null;
                            const emoteRegex = /\[emote:(\d+):.*?\]/;
                            const match = content.match(emoteRegex);
                            if (match && match[1]) { emojiId = match[1]; }

                            if (topluAtlamaAktif) {
                                atlamaSirasi.push({ username: username, emojiId: emojiId });
                                console.log(`QUEUE: ${username} sıraya eklendi. (Sıradaki kişi: ${atlamaSirasi.length})`);
                            } else {
                                console.log(`🚀 '!atla' komutu algılandı: ${username}`);
                                atlaAnimasyonunuBaslat(username, emojiId);
                            }
                        }
                    }
                } catch (error) {
                    console.error("Sohbet mesajı işlenirken hata:", error, event.data);
                }
            };

            ws.onclose = () => {
                console.log("Kick sohbet bağlantısı kesildi. 3 saniye sonra tekrar denenecek.");
                setTimeout(() => connectToKickChat(chatroomId), 3000);
            };

            ws.onerror = (error) => {
                console.error("Kick WebSocket hatası:", error);
                ws.close();
            };
        }

        // --- Ekran Boyutu ve Test Fonksiyonları ---
        function ekranBoyutlariniGuncelle() {
            const yeniGenislik = Math.max(window.innerWidth, document.documentElement.clientWidth) || 1920;
            const yeniYukseklik = Math.max(window.innerHeight, document.documentElement.clientHeight) || 1080;
            if (yeniGenislik !== ekranGenisligi || yeniYukseklik !== ekranYuksekligi) {
                console.log(`📏 Ekran boyutu değişti: ${yeniGenislik}x${yeniYukseklik}`);
                ekranGenisligi = yeniGenislik;
                ekranYuksekligi = yeniYukseklik;
            }
        }
        window.addEventListener('resize', ekranBoyutlariniGuncelle);
        window.addEventListener('orientationchange', ekranBoyutlariniGuncelle);
        window.testAtla = function(kullaniciAdi = 'TestKullanici', emojiId = null) {
            console.log(`🧪 Manuel test atlama: ${kullaniciAdi} (Emoji: ${emojiId})`);
            atlaAnimasyonunuBaslat(kullaniciAdi, emojiId);
        };
        // --- YENİ: Şike testi için özel fonksiyon ---
        window.testSike = function() {
            console.log(`🧪 Manuel 3 SEKMELİ ŞİKE testi: switowski`);
            atlaAnimasyonunuBaslat('switowski', null);
        };
        // --- BİTTİ ---
        window.havuzPozisyonu = function() { console.log(havuz.getBoundingClientRect()); };
        window.karakterPozisyonlari = function() { console.log(`👥 Aktif karakterler:`, karakterPozisyonlari.size, karakterPozisyonlari); };

        // =================================================================
        // --- BAŞLATMA FONKSİYONU (MANUEL ID) ---
        // =================================================================
        function baslat() {
            const chatroomId = AYARLAR.kickChatroomID;

            if (chatroomId && chatroomId !== 0) {
                console.log(`Manuel Chatroom ID ${chatroomId} ile bağlanılıyor...`);
                connectToKickChat(chatroomId);
            } else {
                console.error("!!! BAŞLATMA BAŞARISIZ: Chatroom ID alınamadı.");
                skorGosterici.textContent = `HATA: 'kickChatroomID' ayarlanmamış!`;
                skorGosterici.style.color = "red";
                skorGosterici.style.fontSize = "24px";
            }
        }

        // Sistemi başlat
        baslat();

    });
    </script>
    </body>

</html>
